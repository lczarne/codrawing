<html>
<script src="/js/socket.io.js"></script> 
<script src="/js/paper/paper.js"></script>
<script type="text/paperscript" canvas="myCanvas">


  var socket = io.connect('http://192.168.0.10');
  //var socket = io.connect('http://54.76.227.228');

  socket.on('news', function (data) {
    console.log(data);
    socket.emit('my other event', { my: 'data' });
  });

  socket.on('connect',function(){
    console.log('connected 3');
    socket.send('hello from client');
    document.addEventListener('mousemove',mouseMoveHandler);
    document.addEventListener('mouseup',mouseUpHandler);
    document.addEventListener('mousedown',mouseDownHandler);
    document.addEventListener("keypress", keypressHandler);
  });

var mode = "draw";
function keypressHandler(event) {
  if (mode == "draw") {
    mode = "erase";
  }
  else {
    mode = "draw";
  }
  console.log("mode changed to: "+mode);
}

  var drag = new Object();
  drag.value = 0;
  var start = 0;
  var painting = 0;
  var currentPoint = new Point();
  var path = new Path();

  var RemoteDrawer = function(currentPoint,path){
    this.currentPoint = currentPoint;
    this.path = path;
  }
  var remoteDrawers = new Array();


  function mouseDownHandler(event){
  drawingLayer.activate();

    drag.value = 1;
    sendPaint(event,0);

    currentPoint = new Point(event.offsetX,event.offsetY);
    path = new Path();
    path.strokeColor = 'black';
    path.strokeWidth = 5;

    if (mode == "erase") {
      path.strokeWidth = 25;
      path.blendMode = 'destination-out';

    }
  }

  function mouseMoveHandler(event){
    if (drag.value == 1) {
      sendPaint(event,1);

      var newPoint = new Point(event.offsetX,event.offsetY);
      path.moveTo(currentPoint);
      path.lineTo(newPoint);
      currentPoint = newPoint;
      paper.view.draw();
    };
  }

  function mouseUpHandler(event){
    drag.value = 0;
    sendPaint(event,2);
  }

  function sendPaint(event,state){
    var coordinates = new Object();
      coordinates.x = event.offsetX;
      coordinates.y = event.offsetY;
      var eventToSend = new Object();
      eventToSend.paint = coordinates;
      eventToSend.state = state;
      socket.emit("paint",eventToSend);
  }

  var drawingLayer = new Layer();
  var imageLayer = new Layer();

  drawingLayer.activate();

  var imageCount = 0;
  var lastImage;
  function addImage(imageMedia){
    console.log('got f image')
    var image = new Image;
    var localImageNumber = imageCount++;
    var imageName = 'image'+localImageNumber;
    image.onload = function(newImage) {
      imageLayer.activate();
      var container = document.getElementById("myCanvas");
      container.appendChild(newImage.target);
      var raster = new Raster(imageName);
      imageCoordinates = imageMedia.imageInfo;
      placeImage(raster,imageCoordinates.x,imageCoordinates.y,imageCoordinates.width,imageCoordinates.height);
      lastImage = raster;
      drawingLayer.activate();
    }
    image.id = imageName;
    image.src = imageMedia.imageURL;
  }

  function placeImage(image,x,y,width,height){
    var originX = x+(width/2);
    var originY = y+(height/2);
    image.position = new Point(originX,originY);
    image.size = new Size(width,height);
  }

  function addVideo(videoMedia) {
    var embed = document.createElement('embed');
    embed.src = videoMedia.videoURL;
    videoCoordinates = videoMedia.videoInfo;
    embed.style.position = "absolute";
    embed.width = videoCoordinates.width;
    embed.height = videoCoordinates.height;
    embed.style.left = videoCoordinates.x;
    embed.style.top = videoCoordinates.y;
    embed.setAttribute('controller','true');
    embed.setAttribute('autoplay','true');
    embed.setAttribute('scale','tofit');
    embed.name = "adsfasd";
    document.body.appendChild(embed);
    console.log('added video');
  }

  function addPaint(paintData) {
    console.log("paintData: %j",paintData);
    var state = paintData.state;
    switch(state)
    {
      case 0: {
          var newPoint = new Point(paintData.paint.x,paintData.paint.y);
          createRemoteDrawer(newPoint,paintData.ID);
      }
        break;
      case 1: {
          console.log("my server coordinates: "+paintData.paint.x+" "+paintData.paint.y);
          var newPoint = new Point(paintData.paint.x,paintData.paint.y);
          var currentDrawer = remoteDrawers[paintData.ID];
          if (typeof currentDrawer == "undefined") {
            currentDrawer = createRemoteDrawer(newPoint,paintData.ID);
          }
          currentDrawer.path.moveTo(currentDrawer.currentPoint);
          currentDrawer.path.lineTo(newPoint);
          currentDrawer.currentPoint = newPoint;

          if (paintData.eraser == true) {
            currentDrawer.path.strokeWidth = 25;
            currentDrawer.path.blendMode = 'destination-out';

          }

          paper.view.draw();
      }
      break;
    }
  }

  function createRemoteDrawer(newPoint,drawerId) {
    var newPath = new Path();
    newPath.strokeColor = 'black';
    var newDrawer = new RemoteDrawer(newPoint,newPath); 
    remoteDrawers[drawerId] = newDrawer;
    return newDrawer;
  }

  socket.on('serverImage',function(msg){
    addImage(msg);
  });

  socket.on('serverVideo',function(msg){
    addVideo(msg);
  });

  socket.on('serverPaint',function(msg){
    addPaint(msg);
  });

  socket.on('drawingState',function(msg){
    for (var i = 0; i < msg.length; i++) {
      console.log('message: '+msg[i]);
      addPaint(msg[i]);
    };
  });

  socket.on('imageState',function(msg){
    for (var i = 0; i < msg.length; i++) {
      addImage(msg[i]);
    };
  });

    socket.on('videoState',function(msg){
    for (var i = 0; i < msg.length; i++) {
      addVideo(msg[i]);
    };
  });

</script>
<body>
  <canvas id="myCanvas" style="position:absolute;z-index:-1" resize></canvas>

</body>
</html>