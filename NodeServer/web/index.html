<html>
<script src="/js/socket.io.js"></script> 
<script src="/js/paper/paper.js"></script>
<script type="text/paperscript" canvas="myCanvas">


  //var socket = io.connect('http://192.168.0.10');
  var socket = io.connect('http://54.76.227.228');

  socket.on('news', function (data) {
    console.log(data);
    socket.emit('my other event', { my: 'data' });
  });

  socket.on('connect',function(){
    console.log('connected 3');
    socket.send('hello from client');
    document.addEventListener('mousemove',mouseMoveHandler);
    document.addEventListener('mouseup',mouseUpHandler);
    document.addEventListener('mousedown',mouseDownHandler);
  });


  var drag = new Object();
  drag.value = 0;
  var start = 0;
  var painting = 0;
  var currentPoint = new Point();
  var path = new Path();

  var RemoteDrawer = function(currentPoint,path){
    this.currentPoint = currentPoint;
    this.path = path;
  }
  var remoteDrawers = new Array();


  function mouseDownHandler(event){
    drag.value = 1;
    sendPaint(event,0);

    currentPoint = new Point(event.offsetX,event.offsetY);
    path = new Path();
    path.strokeColor = 'black';
  }

  function mouseMoveHandler(event){
    if (drag.value == 1) {
      sendPaint(event,1);

      var newPoint = new Point(event.offsetX,event.offsetY);
      path.moveTo(currentPoint);
      path.lineTo(newPoint);
      currentPoint = newPoint;
      paper.view.draw();
    };
  }

  function mouseUpHandler(event){
    drag.value = 0;
    sendPaint(event,2);
  }

  function sendPaint(event,state){
    var coordinates = new Object();
      coordinates.x = event.offsetX;
      coordinates.y = event.offsetY;
      var eventToSend = new Object();
      eventToSend.paint = coordinates;
      eventToSend.state = state;
      socket.emit("paint",eventToSend);
  }

  var imageLayer = new Layer();
  var drawingLayer = new Layer();

  drawingLayer.activate();

  var imageCount = 0;
  var lastImage;
  function addImage(imageMedia){
    var image = new Image;
    var localImageNumber = imageCount++;
    var imageName = 'image'+localImageNumber;
    image.onload = function(newImage) {
      imageLayer.activate();
      var container = document.getElementById("myCanvas");
      container.appendChild(newImage.target);
      var raster = new Raster(imageName);
      imageCoordinates = imageMedia.imageInfo;
      placeImage(raster,imageCoordinates.x,imageCoordinates.y,imageCoordinates.width,imageCoordinates.height);
      lastImage = raster;

      drawingLayer.activate();
    }
    image.id = imageName;
    image.src = imageMedia.imageURL;
  }

  function placeImage(image,x,y,width,height){
    var originX = x+(width/2);
    var originY = y+(height/2);
    image.position = new Point(originX,originY);
    image.size = new Size(width,height);
  }

  socket.on('serverImage',function(msg){
    addImage(msg);
  });

  socket.on('serverPaint',function(msg){

    console.log("msg: %j",msg);
    var state = msg.state;
    switch(state)
    {
      case 0: {
          var newPoint = new Point(msg.paint.x,msg.paint.y);
          var newPath = new Path();
          newPath.strokeColor = 'black';
          var newDrawer = new RemoteDrawer(newPoint,newPath);
          remoteDrawers[msg.ID] = newDrawer;
      }
        break;
      case 1: {
          console.log("my server coordinates: "+msg.paint.x+" "+msg.paint.y);
          var newPoint = new Point(msg.paint.x,msg.paint.y);

          var currentDrawer = remoteDrawers[msg.ID];
          currentDrawer.path.moveTo(currentDrawer.currentPoint);
          currentDrawer.path.lineTo(newPoint);
          currentDrawer.currentPoint = newPoint;
          paper.view.draw();
        
      }
      break;
    }

  });


</script>
<body>
  <canvas id="myCanvas" resize></canvas>
</body>
</html>